@page "/"
@using PickForge.Client.Models
@using PickForge.Client.Services
@inject HttpClient Http
@inject AuthService AuthService
@inject NavigationManager Navigation

<div class="app-header">
    <h1 class="app-title">PICKFORGE</h1>
    <button class="btn-logout" @onclick="HandleLogout">LOGOUT</button>
</div>

<div class="control-panel">
    <label>Factor in last</label>
    <input type="number" min="1" max="10" @bind="Recent" />
    <label>weeks</label>
    <button class="btn-primary" disabled="@IsLoading" @onclick="Run">PREDICT</button>
</div>

@if (!string.IsNullOrEmpty(Status) && Status != "Ready." && Status != "Done.")
{
    <p class="@(Status.StartsWith("Error") ? "error-message" : "status-message")">@Status</p>
}

@if (IsLoading)
{
    <p class="loading-message">Loading predictions...</p>
}
else if (Result is not null)
{
    <div class="week-header">
        <h2 class="week-title">WEEK @Result.Week PREDICTIONS</h2>
        <p class="week-subtitle">
            Factor in last <strong>@Result.RecentGames</strong> weeks | 
            Stats through Week @Result.LastCompletedWeek | 
            @Result.Count games
        </p>
    </div>

    @foreach (var g in Result.Games.OrderBy(g => g.Kickoff))
    {
        <div class="game-card">
            <div class="game-header">
                <div class="game-matchup">
                    <span class="matchup-text">@g.AwayTeam at @g.HomeTeam</span>
                </div>
                <div class="game-time">@g.Kickoff.ToLocalTime().ToString("M/d/yyyy h:mm tt")</div>
            </div>

            <div class="pick-section">
                <div class="pick-label">Pick</div>
                <div class="pick-value">
                    @g.Pick
                    <span class="confidence">(@Math.Round(g.Confidence * 100)%)</span>
                </div>
            </div>

            <div class="stats-row">
                <div class="team-stats">
                    <div><span class="stat-label">Home:</span> @g.HomeTeam</div>
                    <div>W-L: <strong>@(g.Home?.Wins ?? 0)-@(g.Home?.Losses ?? 0)</strong></div>
                    <div>PPG: <strong>@((g.Home?.PPG ?? 0).ToString("F1"))</strong></div>
                    <div>PAPG: <strong>@((g.Home?.PAPG ?? 0).ToString("F1"))</strong></div>
                </div>
                <div class="team-stats">
                    <div><span class="stat-label">Away:</span> @g.AwayTeam</div>
                    <div>W-L: <strong>@(g.Away?.Wins ?? 0)-@(g.Away?.Losses ?? 0)</strong></div>
                    <div>PPG: <strong>@((g.Away?.PPG ?? 0).ToString("F1"))</strong></div>
                    <div>PAPG: <strong>@((g.Away?.PAPG ?? 0).ToString("F1"))</strong></div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(g.Notes))
            {
                <div class="notes">@g.Notes</div>
            }
        </div>
    }
}

@code {
    int Recent = 3;
    bool IsLoading;
    string Status = "Ready.";
    PredictResponse? Result;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is authenticated
        if (!await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/login");
            return;
        }
    }

    async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    async Task Run()
    {
        IsLoading = true; Result = null; Status = "Contacting API…";
        StateHasChanged();

        try
        {
            var url = $"/predict?recent={Math.Clamp(Recent, 1, 10)}";
            var data = await Http.GetFromJsonAsync<PredictResponse>(url);
            if (data is null) { Status = "API returned no data."; }
            else { Result = data; Status = "Done."; }
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }
}
