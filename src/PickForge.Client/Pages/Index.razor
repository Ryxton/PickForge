@page "/"
@using PickForge.Client.Models
@using PickForge.Client.Services
@inject HttpClient Http
@inject AuthService AuthService
@inject ScoreboardService ScoreboardService
@inject NavigationManager Navigation

<div class="app-header">
    <h1 class="app-title">PICKFORGE</h1>
    <button class="btn-logout" @onclick="HandleLogout">LOGOUT</button>
</div>

<div class="week-navigation">
    <button class="btn-nav" @onclick="PreviousWeek" disabled="@(SelectedWeek <= 1 || IsLoading)">← PREV</button>
    <span class="week-display">WEEK @SelectedWeek</span>
    <button class="btn-nav" @onclick="NextWeek" disabled="@(SelectedWeek >= MaxWeek || IsLoading)">NEXT →</button>
</div>

@if (SelectedWeek != ActivePicksWeek)
{
    <p class="info-message">📅 Viewing Week @SelectedWeek (Predictions available on Week @ActivePicksWeek)</p>
}

@if (!string.IsNullOrEmpty(Status) && Status != "Ready." && Status != "Done.")
{
    <p class="@(Status.StartsWith("Error") ? "error-message" : "status-message")">@Status</p>
}

@if (IsLoading)
{
    <p class="loading-message">Loading...</p>
}
else if (CurrentWeekData?.Games != null && CurrentWeekData.Games.Any())
{
    <div class="week-header">
        <h2 class="week-title">WEEK @SelectedWeek @(Result != null || StoredPredictions != null ? "PREDICTIONS" : "")</h2>
        @if (Result != null)
        {
            <p class="week-subtitle">
                Factor in last <strong>@Result.RecentGames</strong> weeks |
                Stats through Week @Result.LastCompletedWeek |
                @Result.Count games@(TotalFinished > 0 ? $" ({CorrectCount} correct)" : "")
            </p>
        }
        else if (StoredPredictions != null && StoredPredictions.Predictions.Any())
        {
            <p class="week-subtitle">
                @CurrentWeekData.Games.Count games
                @if (StoredPredictions.TotalFinished > 0)
                {
                    <text> (@StoredPredictions.CorrectCount correct)</text>
                }
            </p>
        }
        else
        {
            <p class="week-subtitle">@CurrentWeekData.Games.Count games</p>
        }
    </div>

    @foreach (var game in CurrentWeekData.Games.OrderBy(g => g.Kickoff))
    {
        // Check for fresh predictions first, then stored predictions
        var prediction = Result?.Games.FirstOrDefault(p =>
            p.HomeTeam == game.HomeTeam && p.AwayTeam == game.AwayTeam);
        
        var storedPrediction = StoredPredictions?.Predictions.FirstOrDefault(p =>
            p.HomeTeam == game.HomeTeam && p.AwayTeam == game.AwayTeam);

        // Determine prediction outcome for styling
        string inlineStyle = "";
        bool? wasCorrect = null;
        
        if (prediction != null && game.IsFinal && game.HomeScore.HasValue && game.AwayScore.HasValue)
        {
            var actualWinner = game.HomeScore.Value > game.AwayScore.Value ? game.HomeTeam : game.AwayTeam;
            var isCorrect = prediction.Pick == actualWinner;
            wasCorrect = isCorrect;
            inlineStyle = isCorrect
                ? "border: 3px solid #10b981; box-shadow: 0 0 16px rgba(16, 185, 129, 0.5);"
                : "border: 3px solid #dc2626; box-shadow: 0 0 16px rgba(220, 38, 38, 0.5);";
        }
        else if (storedPrediction?.WasCorrect.HasValue == true)
        {
            wasCorrect = storedPrediction.WasCorrect.Value;
            inlineStyle = wasCorrect.Value
                ? "border: 3px solid #10b981; box-shadow: 0 0 16px rgba(16, 185, 129, 0.5);"
                : "border: 3px solid #dc2626; box-shadow: 0 0 16px rgba(220, 38, 38, 0.5);";
        }

        <div class="game-card" style="@inlineStyle">
            <div class="game-header">
                <div class="game-matchup">
                    <span class="matchup-text">@game.AwayTeam at @game.HomeTeam</span>
                </div>
                <div class="game-time">@game.Kickoff.ToLocalTime().ToString("M/d h:mm tt")</div>
            </div>

            @if (prediction != null)
            {
                @if (game.IsFinal || game.IsInProgress)
                {
                    <div class="@(game.IsFinal ? "final-score" : "live-score")">
                        <strong>@(game.IsFinal ? "FINAL:" : "LIVE:")</strong> @game.AwayTeam @game.AwayScore, @game.HomeTeam @game.HomeScore
                    </div>
                }

                <div class="pick-section">
                    <div class="pick-label">Pick</div>
                    <div class="pick-value">
                        @prediction.Pick
                        <span class="confidence">(@Math.Round(prediction.Confidence * 100)%)</span>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="team-stats">
                        <div><span class="stat-label">Home:</span> @prediction.HomeTeam</div>
                        <div>W-L: <strong>@(prediction.Home?.Wins ?? 0)-@(prediction.Home?.Losses ?? 0)</strong></div>
                        <div>PPG: <strong>@((prediction.Home?.PPG ?? 0).ToString("F1"))</strong></div>
                        <div>PAPG: <strong>@((prediction.Home?.PAPG ?? 0).ToString("F1"))</strong></div>
                    </div>
                    <div class="team-stats">
                        <div><span class="stat-label">Away:</span> @prediction.AwayTeam</div>
                        <div>W-L: <strong>@(prediction.Away?.Wins ?? 0)-@(prediction.Away?.Losses ?? 0)</strong></div>
                        <div>PPG: <strong>@((prediction.Away?.PPG ?? 0).ToString("F1"))</strong></div>
                        <div>PAPG: <strong>@((prediction.Away?.PAPG ?? 0).ToString("F1"))</strong></div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(prediction.Notes))
                {
                    <div class="notes">@prediction.Notes</div>
                }
            }
            else if (storedPrediction != null)
            {
                @if (game.IsFinal || game.IsInProgress)
                {
                    <div class="@(game.IsFinal ? "final-score" : "live-score")">
                        <strong>@(game.IsFinal ? "FINAL:" : "LIVE:")</strong> @game.AwayTeam @game.AwayScore, @game.HomeTeam @game.HomeScore
                    </div>
                }

                <div class="pick-section">
                    <div class="pick-label">Pick</div>
                    <div class="pick-value">
                        @storedPrediction.PredictedWinner
                        <span class="confidence">(@Math.Round(storedPrediction.Confidence * 100)%)</span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(storedPrediction.Notes))
                {
                    <div class="notes">@storedPrediction.Notes</div>
                }
            }
            else
            {
                @if (game.IsFinal)
                {
                    <div class="final-score">
                        <strong>FINAL:</strong> @game.AwayTeam @game.AwayScore, @game.HomeTeam @game.HomeScore
                    </div>
                }
                else if (game.IsInProgress)
                {
                    <div class="live-score">
                        <strong>LIVE:</strong> @game.AwayTeam @game.AwayScore, @game.HomeTeam @game.HomeScore
                    </div>
                }
                else
                {
                    <div class="upcoming-game">Upcoming</div>
                }
            }
        </div>
    }
}

@code {
    // State
    bool IsLoading;
    string Status = "Ready.";
    PredictResponse? Result;
    WeekPredictionsResponse? StoredPredictions;
    int CorrectCount = 0;
    int TotalFinished = 0;

    // Week navigation state
    int SelectedWeek = 1;
    int ActivePicksWeek = 1;
    int MaxWeek = 18;
    ScoreboardWeekResponse? CurrentWeekData;
    SeasonContextResponse? SeasonContext;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is authenticated
        if (!await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/login");
            return;
        }

        // Load season context and current week
        await LoadSeasonContextAsync();
        await LoadCurrentWeekAsync();
        
        // Auto-predict if on active week
        if (SelectedWeek == ActivePicksWeek)
        {
            await RunPrediction();
        }
    }

    async Task LoadSeasonContextAsync()
    {
        try
        {
            SeasonContext = await ScoreboardService.GetSeasonContextAsync();
            if (SeasonContext != null)
            {
                ActivePicksWeek = SeasonContext.ActivePicksWeek;
                SelectedWeek = ActivePicksWeek;
                MaxWeek = SeasonContext.MaxWeek;
            }
        }
        catch (Exception ex)
        {
            Status = $"Error loading context: {ex.Message}";
        }
    }

    async Task LoadCurrentWeekAsync()
    {
        IsLoading = true;
        try
        {
            CurrentWeekData = await ScoreboardService.GetCurrentWeekAsync();
            Status = "Ready.";
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    async Task NavigateToWeek(int week)
    {
        SelectedWeek = Math.Clamp(week, 1, MaxWeek);
        IsLoading = true;
        Result = null;  // Clear fresh predictions when changing weeks
        StoredPredictions = null;  // Clear stored predictions
        CorrectCount = 0;  // Reset accuracy counters
        TotalFinished = 0;
        
        try
        {
            CurrentWeekData = await ScoreboardService.GetWeekAsync(SelectedWeek);
            Status = "Ready.";
            
            // Auto-predict if navigating to active week
            if (SelectedWeek == ActivePicksWeek)
            {
                await RunPrediction();
            }
            else
            {
                // Try to load stored predictions for past weeks
                await LoadStoredPredictions();
            }
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    async Task LoadStoredPredictions()
    {
        try
        {
            var year = CurrentWeekData?.SeasonYear ?? DateTime.Now.Year;
            var response = await Http.GetFromJsonAsync<WeekPredictionsResponse>(
                $"/api/picks/week/{SelectedWeek}?year={year}");
            
            if (response != null && response.Predictions.Any())
            {
                StoredPredictions = response;
            }
        }
        catch (Exception ex)
        {
            // Silently fail - it's okay if there are no stored predictions
            Console.WriteLine($"No stored predictions found: {ex.Message}");
        }
    }

    async Task PreviousWeek() => await NavigateToWeek(SelectedWeek - 1);
    
    async Task NextWeek() => await NavigateToWeek(SelectedWeek + 1);

    async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    async Task RunPrediction()
    {
        IsLoading = true;
        Result = null;
        Status = "Generating predictions…";
        StateHasChanged();

        try
        {
            // Use a smart default for recent weeks based on current week
            // Early season (weeks 1-4): use 3 weeks
            // Mid season (weeks 5-12): use 4 weeks
            // Late season (weeks 13+): use 5 weeks
            int recentWeeks = ActivePicksWeek switch
            {
                <= 4 => 3,
                <= 12 => 4,
                _ => 5
            };
            
            var url = $"/predict?recent={recentWeeks}";
            var data = await Http.GetFromJsonAsync<PredictResponse>(url);
            if (data is null)
            {
                Status = "API returned no data.";
            }
            else
            {
                Result = data;
                
                // Calculate accuracy for display
                (CorrectCount, TotalFinished) = CalculateAccuracy(Result, CurrentWeekData.Games);
                
                // Save predictions to database
                try
                {
                    var predictions = data.Games.Select(g => new SavePredictionRequest
                    {
                        Week = data.Week,
                        SeasonYear = CurrentWeekData?.SeasonYear ?? DateTime.Now.Year,
                        GameId = g.GameId,
                        HomeTeam = g.HomeTeam,
                        AwayTeam = g.AwayTeam,
                        PredictedWinner = g.Pick,
                        Confidence = g.Confidence,
                        Notes = g.Notes
                    }).ToList();
                    
                    await Http.PostAsJsonAsync("/api/picks", predictions);
                    Status = "Done.";
                }
                catch (Exception saveEx)
                {
                    // Don't fail the whole operation if save fails
                    Status = $"Predictions generated but save failed: {saveEx.Message}";
                }
            }
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    (int correctCount, int totalFinished) CalculateAccuracy(PredictResponse predictions, List<GameViewModel> games)
    {
        int correct = 0;
        int finished = 0;
        
        Console.WriteLine($"CalculateAccuracy called - games count: {games.Count}");
        
        foreach (var game in games)
        {
            if (game.IsFinal && game.HomeScore.HasValue && game.AwayScore.HasValue)
            {
                finished++;
                var prediction = predictions.Games.FirstOrDefault(p =>
                    p.HomeTeam == game.HomeTeam && p.AwayTeam == game.AwayTeam);
                if (prediction != null)
                {
                    var actualWinner = game.HomeScore.Value > game.AwayScore.Value ? game.HomeTeam : game.AwayTeam;
                    if (prediction.Pick == actualWinner)
                    {
                        correct++;
                        Console.WriteLine($"Correct: {game.HomeTeam} vs {game.AwayTeam}");
                    }
                }
            }
        }
        
        Console.WriteLine($"CalculateAccuracy result - correct: {correct}, finished: {finished}");
        return (correct, finished);
    }
}
